import{r as h,a as Se,u as $,b as ye,j as n,d as F,s as Ce,c as Y,e as Re,f as fe,g as Ee}from"./index-DlE2Ebdl.js";import{A as He,C as Ne,N as Ke,R as qe,h as Ye}from"./index-DlE2Ebdl.js";function se(a,m,e){let s=e.initialDeps??[],t;function l(){var c,d,p,y;let x;e.key&&((c=e.debug)!=null&&c.call(e))&&(x=Date.now());const E=a();if(!(E.length!==s.length||E.some((T,P)=>s[P]!==T)))return t;s=E;let C;if(e.key&&((d=e.debug)!=null&&d.call(e))&&(C=Date.now()),t=m(...E),e.key&&((p=e.debug)!=null&&p.call(e))){const T=Math.round((Date.now()-x)*100)/100,P=Math.round((Date.now()-C)*100)/100,D=P/16,M=(O,ne)=>{for(O=String(O);O.length<ne;)O=" "+O;return O};console.info(`%c⏱ ${M(P,5)} /${M(T,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*D,120))}deg 100% 31%);`,e==null?void 0:e.key)}return(y=e==null?void 0:e.onChange)==null||y.call(e,t),t}return l.updateDeps=c=>{s=c},l}function pe(a,m){if(a===void 0)throw new Error("Unexpected undefined");return a}const ze=(a,m)=>Math.abs(a-m)<1.01,Me=(a,m,e)=>{let s;return function(...t){a.clearTimeout(s),s=a.setTimeout(()=>m.apply(this,t),e)}},me=a=>{const{offsetWidth:m,offsetHeight:e}=a;return{width:m,height:e}},Te=a=>a,Ie=a=>{const m=Math.max(a.startIndex-a.overscan,0),e=Math.min(a.endIndex+a.overscan,a.count-1),s=[];for(let t=m;t<=e;t++)s.push(t);return s},Oe=(a,m)=>{const e=a.scrollElement;if(!e)return;const s=a.targetWindow;if(!s)return;const t=c=>{const{width:d,height:p}=c;m({width:Math.round(d),height:Math.round(p)})};if(t(me(e)),!s.ResizeObserver)return()=>{};const l=new s.ResizeObserver(c=>{const d=()=>{const p=c[0];if(p!=null&&p.borderBoxSize){const y=p.borderBoxSize[0];if(y){t({width:y.inlineSize,height:y.blockSize});return}}t(me(e))};a.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(d):d()});return l.observe(e,{box:"border-box"}),()=>{l.unobserve(e)}},ge={passive:!0},ve=typeof window>"u"?!0:"onscrollend"in window,Fe=(a,m)=>{const e=a.scrollElement;if(!e)return;const s=a.targetWindow;if(!s)return;let t=0;const l=a.options.useScrollendEvent&&ve?()=>{}:Me(s,()=>{m(t,!1)},a.options.isScrollingResetDelay),c=x=>()=>{const{horizontal:E,isRtl:j}=a.options;t=E?e.scrollLeft*(j&&-1||1):e.scrollTop,l(),m(t,x)},d=c(!0),p=c(!1);p(),e.addEventListener("scroll",d,ge);const y=a.options.useScrollendEvent&&ve;return y&&e.addEventListener("scrollend",p,ge),()=>{e.removeEventListener("scroll",d),y&&e.removeEventListener("scrollend",p)}},De=(a,m,e)=>{if(m!=null&&m.borderBoxSize){const s=m.borderBoxSize[0];if(s)return Math.round(s[e.options.horizontal?"inlineSize":"blockSize"])}return a[e.options.horizontal?"offsetWidth":"offsetHeight"]},We=(a,{adjustments:m=0,behavior:e},s)=>{var t,l;const c=a+m;(l=(t=s.scrollElement)==null?void 0:t.scrollTo)==null||l.call(t,{[s.options.horizontal?"left":"top"]:c,behavior:e})};class Ae{constructor(m){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let e=null;const s=()=>e||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:e=new this.targetWindow.ResizeObserver(t=>{t.forEach(l=>{const c=()=>{this._measureElement(l.target,l)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(c):c()})}));return{disconnect:()=>{var t;(t=s())==null||t.disconnect(),e=null},observe:t=>{var l;return(l=s())==null?void 0:l.observe(t,{box:"border-box"})},unobserve:t=>{var l;return(l=s())==null?void 0:l.unobserve(t)}}})(),this.range=null,this.setOptions=e=>{Object.entries(e).forEach(([s,t])=>{typeof t>"u"&&delete e[s]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:Te,rangeExtractor:Ie,onChange:()=>{},measureElement:De,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...e}},this.notify=e=>{var s,t;(t=(s=this.options).onChange)==null||t.call(s,this,e)},this.maybeNotify=se(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),e=>{this.notify(e)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(e=>e()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var e;const s=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==s){if(this.cleanup(),!s){this.maybeNotify();return}this.scrollElement=s,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((e=this.scrollElement)==null?void 0:e.window)??null,this.elementsCache.forEach(t=>{this.observer.observe(t)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,t=>{this.scrollRect=t,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(t,l)=>{this.scrollAdjustments=0,this.scrollDirection=l?this.getScrollOffset()<t?"forward":"backward":null,this.scrollOffset=t,this.isScrolling=l,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(e,s)=>{const t=new Map,l=new Map;for(let c=s-1;c>=0;c--){const d=e[c];if(t.has(d.lane))continue;const p=l.get(d.lane);if(p==null||d.end>p.end?l.set(d.lane,d):d.end<p.end&&t.set(d.lane,!0),t.size===this.options.lanes)break}return l.size===this.options.lanes?Array.from(l.values()).sort((c,d)=>c.end===d.end?c.index-d.index:c.end-d.end)[0]:void 0},this.getMeasurementOptions=se(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(e,s,t,l,c)=>(this.pendingMeasuredCacheIndexes=[],{count:e,paddingStart:s,scrollMargin:t,getItemKey:l,enabled:c}),{key:!1}),this.getMeasurements=se(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:e,paddingStart:s,scrollMargin:t,getItemKey:l,enabled:c},d)=>{if(!c)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(x=>{this.itemSizeCache.set(x.key,x.size)}));const p=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const y=this.measurementsCache.slice(0,p);for(let x=p;x<e;x++){const E=l(x),j=this.options.lanes===1?y[x-1]:this.getFurthestMeasurement(y,x),C=j?j.end+this.options.gap:s+t,T=d.get(E),P=typeof T=="number"?T:this.options.estimateSize(x),D=C+P,M=j?j.lane:x%this.options.lanes;y[x]={index:x,start:C,size:P,end:D,key:E,lane:M}}return this.measurementsCache=y,y},{key:!1,debug:()=>this.options.debug}),this.calculateRange=se(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(e,s,t,l)=>this.range=e.length>0&&s>0?Pe({measurements:e,outerSize:s,scrollOffset:t,lanes:l}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=se(()=>{let e=null,s=null;const t=this.calculateRange();return t&&(e=t.startIndex,s=t.endIndex),this.maybeNotify.updateDeps([this.isScrolling,e,s]),[this.options.rangeExtractor,this.options.overscan,this.options.count,e,s]},(e,s,t,l,c)=>l===null||c===null?[]:e({startIndex:l,endIndex:c,overscan:s,count:t}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=e=>{const s=this.options.indexAttribute,t=e.getAttribute(s);return t?parseInt(t,10):(console.warn(`Missing attribute name '${s}={index}' on measured element.`),-1)},this._measureElement=(e,s)=>{const t=this.indexFromElement(e),l=this.measurementsCache[t];if(!l)return;const c=l.key,d=this.elementsCache.get(c);d!==e&&(d&&this.observer.unobserve(d),this.observer.observe(e),this.elementsCache.set(c,e)),e.isConnected&&this.resizeItem(t,this.options.measureElement(e,s,this))},this.resizeItem=(e,s)=>{const t=this.measurementsCache[e];if(!t)return;const l=this.itemSizeCache.get(t.key)??t.size,c=s-l;c!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(t,c,this):t.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=c,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(t.index),this.itemSizeCache=new Map(this.itemSizeCache.set(t.key,s)),this.notify(!1))},this.measureElement=e=>{if(!e){this.elementsCache.forEach((s,t)=>{s.isConnected||(this.observer.unobserve(s),this.elementsCache.delete(t))});return}this._measureElement(e,void 0)},this.getVirtualItems=se(()=>[this.getVirtualIndexes(),this.getMeasurements()],(e,s)=>{const t=[];for(let l=0,c=e.length;l<c;l++){const d=e[l],p=s[d];t.push(p)}return t},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=e=>{const s=this.getMeasurements();if(s.length!==0)return pe(s[be(0,s.length-1,t=>pe(s[t]).start,e)])},this.getOffsetForAlignment=(e,s,t=0)=>{const l=this.getSize(),c=this.getScrollOffset();s==="auto"&&(s=e>=c+l?"end":"start"),s==="center"?e+=(t-l)/2:s==="end"&&(e-=l);const d=this.getTotalSize()+this.options.scrollMargin-l;return Math.max(Math.min(d,e),0)},this.getOffsetForIndex=(e,s="auto")=>{e=Math.max(0,Math.min(e,this.options.count-1));const t=this.measurementsCache[e];if(!t)return;const l=this.getSize(),c=this.getScrollOffset();if(s==="auto")if(t.end>=c+l-this.options.scrollPaddingEnd)s="end";else if(t.start<=c+this.options.scrollPaddingStart)s="start";else return[c,s];const d=s==="end"?t.end+this.options.scrollPaddingEnd:t.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(d,s,t.size),s]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(e,{align:s="start",behavior:t}={})=>{t==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(e,s),{adjustments:void 0,behavior:t})},this.scrollToIndex=(e,{align:s="auto",behavior:t}={})=>{t==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),e=Math.max(0,Math.min(e,this.options.count-1));let l=0;const c=10,d=y=>{if(!this.targetWindow)return;const x=this.getOffsetForIndex(e,y);if(!x){console.warn("Failed to get offset for index:",e);return}const[E,j]=x;this._scrollToOffset(E,{adjustments:void 0,behavior:t}),this.targetWindow.requestAnimationFrame(()=>{const C=this.getScrollOffset(),T=this.getOffsetForIndex(e,j);if(!T){console.warn("Failed to get offset for index:",e);return}ze(T[0],C)||p(j)})},p=y=>{this.targetWindow&&(l++,l<c?this.targetWindow.requestAnimationFrame(()=>d(y)):console.warn(`Failed to scroll to index ${e} after ${c} attempts.`))};d(s)},this.scrollBy=(e,{behavior:s}={})=>{s==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+e,{adjustments:void 0,behavior:s})},this.getTotalSize=()=>{var e;const s=this.getMeasurements();let t;if(s.length===0)t=this.options.paddingStart;else if(this.options.lanes===1)t=((e=s[s.length-1])==null?void 0:e.end)??0;else{const l=Array(this.options.lanes).fill(null);let c=s.length-1;for(;c>=0&&l.some(d=>d===null);){const d=s[c];l[d.lane]===null&&(l[d.lane]=d.end),c--}t=Math.max(...l.filter(d=>d!==null))}return Math.max(t-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(e,{adjustments:s,behavior:t})=>{this.options.scrollToFn(e,{behavior:t,adjustments:s},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(m)}}const be=(a,m,e,s)=>{for(;a<=m;){const t=(a+m)/2|0,l=e(t);if(l<s)a=t+1;else if(l>s)m=t-1;else return t}return a>0?a-1:0};function Pe({measurements:a,outerSize:m,scrollOffset:e,lanes:s}){const t=a.length-1,l=p=>a[p].start;if(a.length<=s)return{startIndex:0,endIndex:t};let c=be(0,t,l,e),d=c;if(s===1)for(;d<t&&a[d].end<e+m;)d++;else if(s>1){const p=Array(s).fill(0);for(;d<t&&p.some(x=>x<e+m);){const x=a[d];p[x.lane]=x.end,d++}const y=Array(s).fill(e+m);for(;c>=0&&y.some(x=>x>=e);){const x=a[c];y[x.lane]=x.start,c--}c=Math.max(0,c-c%s),d=Math.min(t,d+(s-1-d%s))}return{startIndex:c,endIndex:d}}const xe=typeof document<"u"?h.useLayoutEffect:h.useEffect;function Be(a){const m=h.useReducer(()=>({}),{})[1],e={...a,onChange:(t,l)=>{var c;l?Se.flushSync(m):m(),(c=a.onChange)==null||c.call(a,t,l)}},[s]=h.useState(()=>new Ae(e));return s.setOptions(e),xe(()=>s._didMount(),[]),xe(()=>s._willUpdate()),s}function we(a){return Be({observeElementRect:Oe,observeElementOffset:Fe,scrollToFn:We,...a})}const I=160,ke="120px 0px 0px 0px";function Le(){const a=$(i=>i.selectedPeer),m=$(i=>i.conversations),e=$(i=>i.myPubkey),s=$(i=>i.removeMessage),t=$(i=>i.clearConversation),l=$(i=>i.blocked),c=$(i=>i.setBlocked),d=h.useMemo(()=>a?m[a]??[]:[],[m,a]),p=h.useRef(null),[y,x]=h.useState(""),[E,j]=h.useState(null),[C,T]=h.useState([]),[P,D]=h.useState(!1),M=h.useRef(null),O=h.useRef([]),[ne,N]=h.useState(!1),W=h.useRef(null),K=h.useRef(null),[Q,R]=h.useState(!1),V=h.useRef(null),ie=h.useRef([]),G=h.useRef(null),[X,ee]=h.useState(!1),[re,oe]=h.useState(""),{show:b}=ye(),[te,ae]=h.useState(50),B=h.useRef(!1),A=h.useRef(null),[de,_]=h.useState(!1),[U,L]=h.useState(null);h.useEffect(()=>{const i=o=>{o.key==="Escape"&&L(null)};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[]);const le=h.useMemo(()=>d.slice(-te),[d,te]),r=we({count:le.length,getScrollElement:()=>p.current,estimateSize:()=>120,overscan:8});function u(i){return i<1024?`${i} B`:i<1024*1024?`${(i/1024).toFixed(1)} KB`:`${(i/(1024*1024)).toFixed(2)} MB`}function g(i){return{"application/pdf":"pdf","application/zip":"zip","application/json":"json","text/plain":"txt","application/vnd.ms-excel":"xls","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"xlsx","application/msword":"doc","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"docx","application/vnd.ms-powerpoint":"ppt","application/vnd.openxmlformats-officedocument.presentationml.presentation":"pptx"}[i]||""}function w(i){const o=/^data:([^;]+);/.exec(i),f=(o==null?void 0:o[1])||"application/octet-stream",v=g(f);return v?`download.${v}`:"download"}return h.useEffect(()=>{p.current&&(p.current.scrollTop=p.current.scrollHeight)},[d.length]),h.useEffect(()=>{const i=p.current;if(!i)return;r.getTotalSize()-i.scrollTop-i.clientHeight<120&&(i.scrollTop=r.getTotalSize())},[d.length]),h.useEffect(()=>{ae(50)},[a]),h.useEffect(()=>{const i=p.current,o=A.current;if(!i||!o)return;const f=new IntersectionObserver(v=>{const[S]=v;if(S&&S.isIntersecting&&d.length>te&&!B.current){B.current=!0,_(!0);const z=r.getTotalSize(),k=i.scrollTop;ae(H=>{const Z=Math.min(H+50,d.length);return setTimeout(()=>{r.measure();const q=r.getTotalSize();i.scrollTop=q-z+k,B.current=!1,_(!1)},0),Z})}},{root:i,threshold:.01,rootMargin:ke});return f.observe(o),()=>f.disconnect()},[d.length,te]),h.useEffect(()=>{if(!a)return;const i=$.subscribe(o=>{if(o.selectedPeer===a){const f=o.conversations[a]||[],v=f.length?f[f.length-1].ts:0;({...o.lastRead})[a]!==v&&$.getState().markRead(a)}});return()=>{try{i()}catch{}}},[a]),a?(h.useEffect(()=>()=>{var i,o;try{(i=W.current)==null||i.getTracks().forEach(f=>f.stop())}catch{}try{(o=G.current)==null||o.getTracks().forEach(f=>f.stop())}catch{}M.current&&M.current.state!=="inactive"&&M.current.stop(),V.current&&V.current.state!=="inactive"&&V.current.stop()},[]),n.jsxs("section",{role:"main","aria-label":"Direct messages",style:{flex:1,display:"flex",flexDirection:"column"},onDragOver:i=>{i.preventDefault()},onDrop:async i=>{var v,S;i.preventDefault();const o=(S=(v=i.dataTransfer)==null?void 0:v.files)==null?void 0:S[0];if(!o)return;if(o.size>2*1024*1024){b("File too large (>2MB)","error");return}const f=await Y(o);if(F(f)>2*1024*1024){b("Encoded file too large","error");return}j(f)},children:[n.jsxs("header",{style:{padding:"12px 16px",borderBottom:"1px solid var(--border)",display:"flex",alignItems:"center",gap:12,background:"var(--card)"},children:[n.jsxs("div",{style:{fontFamily:"monospace"},children:["Chat with ",a.slice(0,12),"…"]}),n.jsxs("label",{style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[n.jsx("input",{type:"checkbox",checked:!!l[a],onChange:i=>c(a,i.target.checked)})," Block"]}),n.jsx("button",{onClick:()=>{confirm("Clear entire conversation?")&&t(a)},children:"Clear"}),n.jsxs("label",{title:"Encrypt media attachments with a passphrase",style:{marginLeft:8,display:"flex",alignItems:"center",gap:6},children:[n.jsx("input",{type:"checkbox",checked:X,onChange:i=>ee(i.target.checked)})," Encrypt media"]}),X&&n.jsx("input",{type:"password",placeholder:"media passphrase",value:re,onChange:i=>oe(i.target.value),style:{width:160}})]}),n.jsxs("div",{ref:p,style:{flex:1,overflowY:"auto",padding:16,position:"relative",background:"var(--bg)",color:"var(--fg)"},children:[n.jsx("div",{ref:A,style:{height:1}}),n.jsx("div",{style:{height:r.getTotalSize(),width:"100%",position:"relative"},children:r.getVirtualItems().map(i=>{var f,v,S,z;const o=le[i.index];return n.jsx("div",{ref:r.measureElement,style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${i.start}px)`,paddingBottom:8},children:n.jsx("div",{style:{display:"flex",justifyContent:o.from===e?"flex-end":"flex-start"},children:n.jsxs("div",{style:{maxWidth:520},children:[o.text&&n.jsx("div",{style:{background:"var(--bubble)",color:"var(--bubble-fg)",borderRadius:12,padding:"8px 10px"},children:o.text}),((f=o.attachment)==null?void 0:f.startsWith("data:image/"))&&n.jsx("div",{title:"Open image",onClick:()=>L({type:"image",src:o.attachment}),style:{width:I,height:I,borderRadius:8,overflow:"hidden",background:"var(--border)",cursor:"pointer"},children:n.jsx("img",{src:o.attachment,alt:"image",loading:"lazy",decoding:"async",style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}})}),((v=o.attachment)==null?void 0:v.startsWith("data:video/"))&&n.jsxs("div",{title:"Play video",onClick:()=>L({type:"video",src:o.attachment}),style:{width:I,height:I,borderRadius:8,overflow:"hidden",background:"#000",position:"relative",cursor:"pointer"},children:[n.jsx("video",{src:o.attachment,muted:!0,preload:"metadata",style:{width:"100%",height:"100%",objectFit:"cover",display:"block",pointerEvents:"none"}}),n.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:28,textShadow:"0 1px 2px rgba(0,0,0,0.6)"},children:"▶"})]}),((S=o.attachment)==null?void 0:S.startsWith("data:audio/"))&&n.jsx("button",{title:"Play audio",onClick:()=>L({type:"audio",src:o.attachment}),style:{padding:"6px 10px",borderRadius:16,background:"var(--card)",border:"1px solid var(--border)",color:"var(--fg)",cursor:"pointer"},children:"♫ Audio"}),o.attachment&&o.attachment.startsWith("data:")&&!o.attachment.startsWith("data:image/")&&!o.attachment.startsWith("data:video/")&&!o.attachment.startsWith("data:audio/")&&n.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[n.jsxs("a",{href:o.attachment,download:w(o.attachment),style:{display:"inline-flex",alignItems:"center",gap:6,color:"var(--accent)"},children:["📎 Download file (",u(F(o.attachment)),")"]}),n.jsx("button",{style:{fontSize:12},onClick:async()=>{try{await navigator.clipboard.writeText(o.attachment),b("Link copied","success")}catch{b("Copy failed","error")}},children:"Copy link"}),n.jsx("button",{style:{fontSize:12},onClick:async()=>{try{const k=/^data:([^;]+);base64,(.*)$/.exec(o.attachment);if(!k)throw new Error("not data url");const H=k[1],Z=k[2],q=atob(Z),ue=new Uint8Array(q.length);for(let J=0;J<q.length;J++)ue[J]=q.charCodeAt(J);const ce=new Blob([ue],{type:H});window.ClipboardItem?(await navigator.clipboard.write([new window.ClipboardItem({[H]:ce})]),b("File copied","success")):b("ClipboardItem unsupported","error")}catch{b("Copy failed","error")}},children:"Copy as file"})]}),(z=o.attachments)==null?void 0:z.map((k,H)=>k.startsWith("data:image/")?n.jsx("div",{title:"Open image",onClick:()=>L({type:"image",src:k}),style:{width:I,height:I,borderRadius:8,overflow:"hidden",background:"var(--border)",cursor:"pointer"},children:n.jsx("img",{src:k,alt:"image",loading:"lazy",decoding:"async",style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}})},H):k.startsWith("data:video/")?n.jsxs("div",{title:"Play video",onClick:()=>L({type:"video",src:k}),style:{width:I,height:I,borderRadius:8,overflow:"hidden",background:"#000",position:"relative",cursor:"pointer"},children:[n.jsx("video",{src:k,muted:!0,preload:"metadata",style:{width:"100%",height:"100%",objectFit:"cover",display:"block",pointerEvents:"none"}}),n.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:28,textShadow:"0 1px 2px rgba(0,0,0,0.6)"},children:"▶"})]},H):k.startsWith("data:audio/")?n.jsx("button",{title:"Play audio",onClick:()=>L({type:"audio",src:k}),style:{padding:"6px 10px",borderRadius:16,background:"var(--card)",border:"1px solid var(--border)",color:"var(--fg)",cursor:"pointer"},children:"♫ Audio"},H):k.startsWith("data:")?n.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[n.jsxs("a",{href:k,download:w(k),style:{display:"inline-flex",alignItems:"center",gap:6,color:"var(--accent)"},children:["📎 Download file (",u(F(k)),")"]}),n.jsx("button",{style:{fontSize:12},onClick:async()=>{try{await navigator.clipboard.writeText(k),b("Link copied","success")}catch{b("Copy failed","error")}},children:"Copy link"}),n.jsx("button",{style:{fontSize:12},onClick:async()=>{try{const Z=/^data:([^;]+);base64,(.*)$/.exec(k);if(!Z)throw new Error("not data url");const q=Z[1],ue=Z[2],ce=atob(ue),J=new Uint8Array(ce.length);for(let he=0;he<ce.length;he++)J[he]=ce.charCodeAt(he);const je=new Blob([J],{type:q});window.ClipboardItem?(await navigator.clipboard.write([new window.ClipboardItem({[q]:je})]),b("File copied","success")):b("ClipboardItem unsupported","error")}catch{b("Copy failed","error")}},children:"Copy as file"})]},H):null),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:2},children:[n.jsx("div",{style:{fontSize:10,color:"var(--muted)"},children:new Date(o.ts*1e3).toLocaleTimeString()}),o.status&&n.jsx("span",{style:{fontSize:10,color:o.status==="failed"?"#d32f2f":"var(--muted)"},children:o.status}),n.jsx("button",{style:{fontSize:10},onClick:()=>{confirm("Delete this message locally?")&&s(a,o.id)},children:"Delete"})]})]})})},i.key)})}),de&&n.jsx("div",{style:{textAlign:"center",fontSize:12,color:"var(--muted)",padding:6},children:"Loading…"})]}),U&&n.jsxs("div",{onClick:()=>L(null),style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.8)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},children:[n.jsxs("div",{onClick:i=>i.stopPropagation(),style:{maxWidth:"90vw",maxHeight:"90vh"},children:[U.type==="image"&&n.jsx("img",{src:U.src,alt:"image",style:{maxWidth:"90vw",maxHeight:"90vh",objectFit:"contain",display:"block"}}),U.type==="video"&&n.jsx("video",{controls:!0,autoPlay:!0,src:U.src,style:{maxWidth:"90vw",maxHeight:"90vh"}}),U.type==="audio"&&n.jsx("audio",{controls:!0,src:U.src,style:{width:"80vw"}})]}),n.jsx("button",{onClick:()=>L(null),style:{position:"fixed",top:16,right:16,fontSize:18,background:"var(--card)",color:"var(--fg)",border:"1px solid var(--border)",borderRadius:6,padding:"6px 10px",cursor:"pointer"},children:"✖"})]}),n.jsxs("footer",{className:"sticky-footer",style:{borderTop:"1px solid var(--border)",padding:12,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[n.jsx("input",{placeholder:"type a message",value:y,onChange:async i=>{x(i.target.value);const o=localStorage.getItem("nostr_sk");if(o&&i.target.value.trim())try{await Ce(o,a)}catch{}},style:{flex:1}}),n.jsx("input",{type:"file",multiple:!0,onChange:async i=>{var S;if(!((S=i.target.files)==null?void 0:S[0]))return;const f=Array.from(i.target.files||[]),v=[];for(const z of f){if(z.size>2*1024*1024){b("File too large (>2MB)","error");continue}const k=await Y(z);if(F(k)>2*1024*1024){b("Encoded file too large","error");continue}v.push(k)}v.length===1&&j(v[0]),v.length>1&&T(v)}}),ne?n.jsxs(n.Fragment,{children:[n.jsx("video",{ref:K,autoPlay:!0,muted:!0,style:{width:120,height:72,background:"#000",borderRadius:6}}),n.jsx("button",{title:"Capture",onClick:async()=>{const i=K.current,o=W.current;if(!i||!o)return;const f=i.videoWidth||640,v=i.videoHeight||360,S=document.createElement("canvas");S.width=f,S.height=v;const z=S.getContext("2d");if(z){z.drawImage(i,0,0,f,v);const k=S.toDataURL("image/jpeg",.9);if(F(k)>2*1024*1024){b("Photo too large","error");return}j(k)}o.getTracks().forEach(k=>k.stop()),N(!1),W.current=null},children:"📸"}),n.jsx("button",{title:"Cancel",onClick:()=>{const i=W.current;i&&i.getTracks().forEach(o=>o.stop()),N(!1),W.current=null},children:"✖️"})]}):n.jsx("button",{title:"Take photo",onClick:async()=>{if(!navigator.mediaDevices){b("Camera unsupported","error");return}try{const i=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});W.current=i,N(!0),setTimeout(()=>{K.current&&(K.current.srcObject=i)},0)}catch{b("Failed to access camera","error")}},children:"📷"}),P?n.jsx("button",{onClick:()=>{const i=M.current;i&&i.state!=="inactive"&&i.stop(),i&&i.stream.getTracks().forEach(o=>o.stop())},children:"⏹️"}):n.jsx("button",{onClick:async()=>{if(!navigator.mediaDevices||typeof MediaRecorder>"u"){b("Recording unsupported","error");return}const i=await navigator.mediaDevices.getUserMedia({audio:!0}),o=new MediaRecorder(i);M.current=o,O.current=[],o.ondataavailable=f=>{f.data.size&&O.current.push(f.data)},o.onstop=async()=>{const f=new Blob(O.current,{type:"audio/webm"});if(f.size>1024*1024){D(!1),b("Voice note too large (>1MB)","error");return}const v=await Y(f);if(F(v)>1024*1024){D(!1),b("Encoded audio too large","error");return}j(v),D(!1)},o.start(),D(!0)},children:"🎙️"}),Q?n.jsx("button",{title:"Stop video",onClick:()=>{const i=V.current;i&&i.state!=="inactive"&&i.stop();const o=G.current;o&&o.getTracks().forEach(f=>f.stop())},children:"⏹️"}):n.jsx("button",{title:"Record video",onClick:async()=>{if(!navigator.mediaDevices||typeof MediaRecorder>"u"){b("Recording unsupported","error");return}try{const i=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});G.current=i;const o=MediaRecorder.isTypeSupported("video/webm;codecs=vp8,opus")?"video/webm;codecs=vp8,opus":"video/webm",f=new MediaRecorder(i,{mimeType:o});V.current=f,ie.current=[],f.ondataavailable=v=>{v.data.size&&ie.current.push(v.data)},f.onstop=async()=>{const v=new Blob(ie.current,{type:"video/webm"});if(v.size>2*1024*1024){R(!1),i.getTracks().forEach(z=>z.stop()),b("Video too large (>2MB)","error");return}const S=await Y(v);if(F(S)>2*1024*1024){R(!1),i.getTracks().forEach(z=>z.stop()),b("Encoded video too large","error");return}j(S),R(!1),i.getTracks().forEach(z=>z.stop()),G.current=null},f.start(),R(!0)}catch{b("Failed to access camera","error")}},children:"🎥"}),E&&n.jsx("span",{style:{fontSize:12},children:"attachment ready"}),C.length>0&&n.jsxs("span",{style:{fontSize:12},children:[C.length," files ready"]}),n.jsx("button",{style:{minWidth:88},onClick:async()=>{if(navigator.vibrate)try{navigator.vibrate(15)}catch{}const i=localStorage.getItem("nostr_sk");if(!i)return;if(l[a]){b("This contact is blocked","error");return}const o=X&&(E||C.length)?re:void 0;if(X&&(E||C.length)&&!o){b("Enter a media passphrase","error");return}await Re(i,a,{t:y||void 0,a:E||void 0,as:C.length?C:void 0,p:o}),x(""),j(null),T([])},disabled:!y&&!E,children:"Send"})]})]})):n.jsx("section",{style:{flex:1,padding:16},children:"Select a chat"})}function Ve(){const a=fe(r=>r.selectedRoom),m=fe(r=>r.messages),e=$(r=>r.myPubkey),s=h.useMemo(()=>a?m[a]??[]:[],[m,a]),t=h.useRef(null),[l,c]=h.useState(""),[d,p]=h.useState(null),[y,x]=h.useState([]),[E,j]=h.useState(!1),C=h.useRef(null),T=h.useRef([]),[P,D]=h.useState(!1),M=h.useRef(null),O=h.useRef(null),[ne,N]=h.useState(!1),W=h.useRef(null),K=h.useRef([]),Q=h.useRef(null),{show:R}=ye(),[V,ie]=h.useState(!1),[G,X]=h.useState(""),[ee,re]=h.useState(50),oe=h.useRef(!1),b=h.useRef(null),[te,ae]=h.useState(!1),[B,A]=h.useState(null);h.useEffect(()=>{const r=u=>{u.key==="Escape"&&A(null)};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[]);const de=h.useMemo(()=>s.slice(-ee),[s,ee]),_=we({count:de.length,getScrollElement:()=>t.current,estimateSize:()=>120,overscan:8});function U(r){return r<1024?`${r} B`:r<1024*1024?`${(r/1024).toFixed(1)} KB`:`${(r/(1024*1024)).toFixed(2)} MB`}function L(r){return{"application/pdf":"pdf","application/zip":"zip","application/json":"json","text/plain":"txt","application/vnd.ms-excel":"xls","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"xlsx","application/msword":"doc","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"docx","application/vnd.ms-powerpoint":"ppt","application/vnd.openxmlformats-officedocument.presentationml.presentation":"pptx"}[r]||""}function le(r){const u=/^data:([^;]+);/.exec(r),g=(u==null?void 0:u[1])||"application/octet-stream",w=L(g);return w?`download.${w}`:"download"}return h.useEffect(()=>{t.current&&(t.current.scrollTop=t.current.scrollHeight)},[s.length]),h.useEffect(()=>{const r=t.current;if(!r)return;_.getTotalSize()-r.scrollTop-r.clientHeight<120&&(r.scrollTop=_.getTotalSize())},[s.length]),h.useEffect(()=>{re(50)},[a]),h.useEffect(()=>{const r=t.current,u=b.current;if(!r||!u)return;const g=new IntersectionObserver(w=>{const[i]=w;if(i&&i.isIntersecting&&s.length>ee&&!oe.current){oe.current=!0,ae(!0);const o=_.getTotalSize(),f=r.scrollTop;re(v=>{const S=Math.min(v+50,s.length);return setTimeout(()=>{_.measure();const z=_.getTotalSize();r.scrollTop=z-o+f,oe.current=!1,ae(!1)},0),S})}},{root:r,threshold:.01,rootMargin:ke});return g.observe(u),()=>g.disconnect()},[s.length,ee]),a?(h.useEffect(()=>()=>{var r,u;try{(r=M.current)==null||r.getTracks().forEach(g=>g.stop())}catch{}try{(u=Q.current)==null||u.getTracks().forEach(g=>g.stop())}catch{}C.current&&C.current.state!=="inactive"&&C.current.stop(),W.current&&W.current.state!=="inactive"&&W.current.stop()},[]),n.jsxs("section",{role:"main","aria-label":"Room messages",style:{flex:1,display:"flex",flexDirection:"column"},onDragOver:r=>{r.preventDefault()},onDrop:async r=>{var w,i;r.preventDefault();const u=(i=(w=r.dataTransfer)==null?void 0:w.files)==null?void 0:i[0];if(!u)return;if(u.size>2*1024*1024){R("File too large (>2MB)","error");return}const g=await Y(u);if(F(g)>2*1024*1024){R("Encoded file too large","error");return}p(g)},children:[n.jsxs("header",{style:{padding:"12px 16px",borderBottom:"1px solid var(--border)",display:"flex",alignItems:"center",gap:12,background:"var(--card)"},children:[n.jsxs("div",{style:{fontFamily:"monospace"},children:["Room ",a.slice(0,12),"…"]}),n.jsxs("label",{title:"Encrypt media attachments with a passphrase",style:{marginLeft:"auto",display:"flex",alignItems:"center",gap:6},children:[n.jsx("input",{type:"checkbox",checked:V,onChange:r=>ie(r.target.checked)})," Encrypt media"]}),V&&n.jsx("input",{type:"password",placeholder:"media passphrase",value:G,onChange:r=>X(r.target.value),style:{width:160}})]}),n.jsxs("div",{ref:t,style:{flex:1,overflowY:"auto",padding:16,position:"relative",background:"var(--bg)",color:"var(--fg)"},children:[n.jsx("div",{ref:b,style:{height:1}}),n.jsx("div",{style:{height:_.getTotalSize(),width:"100%",position:"relative"},children:_.getVirtualItems().map(r=>{var g,w,i,o;const u=de[r.index];return n.jsx("div",{ref:_.measureElement,style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${r.start}px)`,paddingBottom:8},children:n.jsx("div",{style:{display:"flex",justifyContent:u.from===e?"flex-end":"flex-start"},children:n.jsxs("div",{style:{maxWidth:520},children:[u.text&&n.jsx("div",{style:{background:"var(--bubble)",color:"var(--bubble-fg)",borderRadius:12,padding:"8px 10px"},children:u.text}),((g=u.attachment)==null?void 0:g.startsWith("data:image/"))&&n.jsx("div",{title:"Open image",onClick:()=>A({type:"image",src:u.attachment}),style:{width:I,height:I,borderRadius:8,overflow:"hidden",background:"var(--border)",cursor:"pointer"},children:n.jsx("img",{src:u.attachment,alt:"image",loading:"lazy",decoding:"async",style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}})}),((w=u.attachment)==null?void 0:w.startsWith("data:video/"))&&n.jsxs("div",{title:"Play video",onClick:()=>A({type:"video",src:u.attachment}),style:{width:I,height:I,borderRadius:8,overflow:"hidden",background:"#000",position:"relative",cursor:"pointer"},children:[n.jsx("video",{src:u.attachment,muted:!0,preload:"metadata",style:{width:"100%",height:"100%",objectFit:"cover",display:"block",pointerEvents:"none"}}),n.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:28,textShadow:"0 1px 2px rgba(0,0,0,0.6)"},children:"▶"})]}),((i=u.attachment)==null?void 0:i.startsWith("data:audio/"))&&n.jsx("button",{title:"Play audio",onClick:()=>A({type:"audio",src:u.attachment}),style:{padding:"6px 10px",borderRadius:16,background:"var(--card)",border:"1px solid var(--border)",color:"var(--fg)",cursor:"pointer"},children:"♫ Audio"}),u.attachment&&u.attachment.startsWith("data:")&&!u.attachment.startsWith("data:image/")&&!u.attachment.startsWith("data:video/")&&!u.attachment.startsWith("data:audio/")&&n.jsx("div",{style:{display:"flex",gap:8,alignItems:"center"},children:n.jsxs("a",{href:u.attachment,download:le(u.attachment),style:{display:"inline-flex",alignItems:"center",gap:6,color:"var(--accent)"},children:["📎 Download file (",U(F(u.attachment)),")"]})}),(o=u.attachments)==null?void 0:o.map((f,v)=>f.startsWith("data:image/")?n.jsx("div",{title:"Open image",onClick:()=>A({type:"image",src:f}),style:{width:I,height:I,borderRadius:8,overflow:"hidden",background:"var(--border)",cursor:"pointer"},children:n.jsx("img",{src:f,alt:"image",loading:"lazy",decoding:"async",style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}})},v):f.startsWith("data:video/")?n.jsxs("div",{title:"Play video",onClick:()=>A({type:"video",src:f}),style:{width:I,height:I,borderRadius:8,overflow:"hidden",background:"#000",position:"relative",cursor:"pointer"},children:[n.jsx("video",{src:f,muted:!0,preload:"metadata",style:{width:"100%",height:"100%",objectFit:"cover",display:"block",pointerEvents:"none"}}),n.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:28,textShadow:"0 1px 2px rgba(0,0,0,0.6)"},children:"▶"})]},v):f.startsWith("data:audio/")?n.jsx("button",{title:"Play audio",onClick:()=>A({type:"audio",src:f}),style:{padding:"6px 10px",borderRadius:16,background:"var(--card)",border:"1px solid var(--border)",color:"var(--fg)",cursor:"pointer"},children:"♫ Audio"},v):f.startsWith("data:")?n.jsx("div",{style:{display:"flex",gap:8,alignItems:"center"},children:n.jsxs("a",{href:f,download:le(f),style:{display:"inline-flex",alignItems:"center",gap:6,color:"var(--accent)"},children:["📎 Download file (",U(F(f)),")"]})},v):null),n.jsx("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:2},children:n.jsx("div",{style:{fontSize:10,color:"var(--muted)"},children:new Date(u.ts*1e3).toLocaleTimeString()})})]})})},r.key)})}),te&&n.jsx("div",{style:{textAlign:"center",fontSize:12,color:"var(--muted)",padding:6},children:"Loading…"})]}),B&&n.jsxs("div",{onClick:()=>A(null),style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.8)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},children:[n.jsxs("div",{onClick:r=>r.stopPropagation(),style:{maxWidth:"90vw",maxHeight:"90vh"},children:[B.type==="image"&&n.jsx("img",{src:B.src,alt:"image",style:{maxWidth:"90vw",maxHeight:"90vh",objectFit:"contain",display:"block"}}),B.type==="video"&&n.jsx("video",{controls:!0,autoPlay:!0,src:B.src,style:{maxWidth:"90vw",maxHeight:"90vh"}}),B.type==="audio"&&n.jsx("audio",{controls:!0,src:B.src,style:{width:"80vw"}})]}),n.jsx("button",{onClick:()=>A(null),style:{position:"fixed",top:16,right:16,fontSize:18,background:"var(--card)",color:"var(--fg)",border:"1px solid var(--border)",borderRadius:6,padding:"6px 10px",cursor:"pointer"},children:"✖"})]}),n.jsxs("footer",{className:"sticky-footer",style:{borderTop:"1px solid var(--border)",padding:12,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[n.jsx("input",{placeholder:"type a message",value:l,onChange:r=>c(r.target.value),style:{flex:1}}),n.jsx("input",{type:"file",multiple:!0,onChange:async r=>{const u=Array.from(r.target.files||[]),g=[];for(const w of u){if(w.size>2*1024*1024){R("File too large (>2MB)","error");continue}const i=await Y(w);if(F(i)>2*1024*1024){R("Encoded file too large","error");continue}g.push(i)}g.length===1&&p(g[0]),g.length>1&&x(g)}}),P?n.jsxs(n.Fragment,{children:[n.jsx("video",{ref:O,autoPlay:!0,muted:!0,style:{width:120,height:72,background:"#000",borderRadius:6}}),n.jsx("button",{title:"Capture",onClick:async()=>{const r=O.current,u=M.current;if(!r||!u)return;const g=r.videoWidth||640,w=r.videoHeight||360,i=document.createElement("canvas");i.width=g,i.height=w;const o=i.getContext("2d");if(o){o.drawImage(r,0,0,g,w);const f=i.toDataURL("image/jpeg",.9);if(F(f)>2*1024*1024){R("Photo too large","error");return}p(f)}u.getTracks().forEach(f=>f.stop()),D(!1),M.current=null},children:"📸"}),n.jsx("button",{title:"Cancel",onClick:()=>{const r=M.current;r&&r.getTracks().forEach(u=>u.stop()),D(!1),M.current=null},children:"✖️"})]}):n.jsx("button",{title:"Take photo",onClick:async()=>{if(!navigator.mediaDevices){R("Camera unsupported","error");return}try{const r=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});M.current=r,D(!0),setTimeout(()=>{O.current&&(O.current.srcObject=r)},0)}catch{R("Failed to access camera","error")}},children:"📷"}),E?n.jsx("button",{onClick:()=>{const r=C.current;r&&r.state!=="inactive"&&r.stop(),r&&r.stream.getTracks().forEach(u=>u.stop())},children:"⏹️"}):n.jsx("button",{onClick:async()=>{if(!navigator.mediaDevices||typeof MediaRecorder>"u"){R("Recording unsupported","error");return}const r=await navigator.mediaDevices.getUserMedia({audio:!0}),u=new MediaRecorder(r);C.current=u,T.current=[],u.ondataavailable=g=>{g.data.size&&T.current.push(g.data)},u.onstop=async()=>{const g=new Blob(T.current,{type:"audio/webm"});if(g.size>1024*1024){j(!1),R("Voice note too large (>1MB)","error");return}const w=await Y(g);if(F(w)>1024*1024){j(!1),R("Encoded audio too large","error");return}p(w),j(!1)},u.start(),j(!0)},children:"🎙️"}),ne?n.jsx("button",{title:"Stop video",onClick:()=>{const r=W.current;r&&r.state!=="inactive"&&r.stop();const u=Q.current;u&&u.getTracks().forEach(g=>g.stop())},children:"⏹️"}):n.jsx("button",{title:"Record video",onClick:async()=>{if(!navigator.mediaDevices||typeof MediaRecorder>"u"){R("Recording unsupported","error");return}try{const r=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});Q.current=r;const u=MediaRecorder.isTypeSupported("video/webm;codecs=vp8,opus")?"video/webm;codecs=vp8,opus":"video/webm",g=new MediaRecorder(r,{mimeType:u});W.current=g,K.current=[],g.ondataavailable=w=>{w.data.size&&K.current.push(w.data)},g.onstop=async()=>{const w=new Blob(K.current,{type:"video/webm"});if(w.size>2*1024*1024){N(!1),r.getTracks().forEach(o=>o.stop()),R("Video too large (>2MB)","error");return}const i=await Y(w);if(F(i)>2*1024*1024){N(!1),r.getTracks().forEach(o=>o.stop()),R("Encoded video too large","error");return}p(i),N(!1),r.getTracks().forEach(o=>o.stop()),Q.current=null},g.start(),N(!0)}catch{R("Failed to access camera","error")}},children:"🎥"}),d&&n.jsx("span",{style:{fontSize:12},children:"attachment ready"}),y.length>0&&n.jsxs("span",{style:{fontSize:12},children:[y.length," files ready"]}),n.jsx("button",{style:{minWidth:88},onClick:async()=>{const r=localStorage.getItem("nostr_sk");if(!r||!a)return;const u=V&&(d||y.length)?G:void 0;if(V&&(d||y.length)&&!u){R("Enter a media passphrase","error");return}if(navigator.vibrate)try{navigator.vibrate(15)}catch{}await Ee(r,a,l||void 0,{a:d||void 0,as:y.length?y:void 0,p:u}),c(""),p(null),x([])},disabled:!l&&!d,children:"Send"})]})]})):n.jsx("section",{style:{flex:1,padding:16},children:"Select a room"})}export{He as App,Ne as ChatList,Le as ChatWindow,Ke as NostrEngine,qe as RelayManager,Ye as RoomList,Ve as RoomWindow};
