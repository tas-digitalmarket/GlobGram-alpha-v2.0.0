<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست مشکل کلیدها - GlobGram</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .output { background: #000; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; margin: 10px 0; min-height: 300px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-danger { background: #ff4757; color: white; }
        .btn-success { background: #2ed573; color: white; }
        .btn-info { background: #3742fa; color: white; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 تشخیص مشکل "invalid-event" در GlobGram</h1>
        
        <div id="status"></div>
        
        <div>
            <button class="btn btn-info" onclick="runDiagnostics()">🔍 تشخیص مشکل</button>
            <button class="btn btn-danger" onclick="clearAndRegenerate()">🗑️ پاک کردن و ایجاد کلید جدید</button>
            <button class="btn btn-success" onclick="testEventCreation()">📝 تست ایجاد Event</button>
            <button class="btn btn-info" onclick="testRelayConnection()">🌐 تست اتصال Relay</button>
        </div>
        
        <div class="output" id="output">آماده برای تست...</div>
    </div>

    <script type="module">
        const output = document.getElementById('output');
        const status = document.getElementById('status');
        
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const prefix = type === 'error' ? '❌' : type === 'warn' ? '⚠️' : type === 'success' ? '✅' : 'ℹ️';
            const line = `[${timestamp}] ${prefix} ${msg}`;
            console.log(line);
            output.innerHTML += line + '\n';
            output.scrollTop = output.scrollHeight;
        }
        
        function setStatus(msg, type = 'info') {
            status.innerHTML = `<div class="status ${type}">${msg}</div>`;
        }
        
        // Helper functions
        const hexToBytes = (hex) => {
            if (hex.length % 2 !== 0) throw new Error('طول hex نامعتبر است');
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.slice(i, i + 2), 16);
            }
            return bytes;
        };
        
        const bytesToHex = (bytes) => {
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        };
        
        // Main diagnostic function
        window.runDiagnostics = async function() {
            output.innerHTML = '';
            log('🔍 شروع تشخیص مشکل...');
            
            try {
                // 1. Check localStorage
                const sk = localStorage.getItem('nostr_sk');
                log(`کلید خصوصی موجود: ${!!sk}`);
                log(`طول کلید: ${sk?.length || 'نامشخص'}`);
                log(`فرمت hex معتبر: ${/^[0-9a-f]{64}$/i.test(sk || '')}`);
                
                if (!sk) {
                    setStatus('❌ کلید خصوصی یافت نشد! ابتدا یک Identity ایجاد کنید.', 'error');
                    return;
                }
                
                // 2. Test hex conversion
                let skBytes;
                try {
                    skBytes = hexToBytes(sk);
                    log(`✅ تبدیل hex به bytes موفق: ${skBytes.length} بایت`);
                } catch (e) {
                    log(`❌ خطا در تبدیل hex: ${e.message}`, 'error');
                    setStatus('❌ کلید خصوصی کورپت شده است. کلید جدید ایجاد کنید.', 'error');
                    return;
                }
                
                // 3. Test nostr-tools import
                let nostrTools;
                try {
                    nostrTools = await import('nostr-tools');
                    log(`✅ nostr-tools با موفقیت import شد`);
                    log(`ابزارهای موجود: ${Object.keys(nostrTools).slice(0, 10).join(', ')}...`);
                } catch (e) {
                    log(`❌ خطا در import nostr-tools: ${e.message}`, 'error');
                    setStatus('❌ مشکل در کتابخانه nostr-tools', 'error');
                    return;
                }
                
                // 4. Test public key generation
                let pk;
                try {
                    pk = nostrTools.getPublicKey(skBytes);
                    log(`✅ کلید عمومی تولید شد: ${pk.slice(0, 16)}...`);
                } catch (e) {
                    log(`❌ خطا در تولید کلید عمومی: ${e.message}`, 'error');
                    setStatus('❌ مشکل در تولید کلید عمومی', 'error');
                    return;
                }
                
                // 5. Test event creation
                try {
                    const now = Math.floor(Date.now() / 1000);
                    const template = {
                        kind: 1,
                        created_at: now,
                        content: 'تست پیام از GlobGram',
                        tags: []
                    };
                    
                    const event = nostrTools.finalizeEvent(template, skBytes);
                    log(`✅ Event ایجاد شد: ID=${event.id?.slice(0, 16)}...`);
                    log(`  نوع: ${event.kind}`);
                    log(`  کلید عمومی: ${event.pubkey?.slice(0, 16)}...`);
                    log(`  طول امضا: ${event.sig?.length}`);
                    
                    // Validate event fields
                    const required = ['id', 'pubkey', 'created_at', 'kind', 'tags', 'content', 'sig'];
                    const missing = required.filter(field => !(field in event));
                    
                    if (missing.length > 0) {
                        log(`❌ فیلدهای ناقص: ${missing.join(', ')}`, 'error');
                        setStatus('❌ Event نامعتبر - فیلدهای ناقص', 'error');
                        return;
                    }
                    
                    // Check field validity
                    if (event.pubkey !== pk) {
                        log(`❌ عدم تطابق کلید عمومی!`, 'error');
                        log(`  تولید شده: ${pk}`);
                        log(`  در Event: ${event.pubkey}`);
                        setStatus('❌ عدم تطابق کلید عمومی در Event', 'error');
                        return;
                    }
                    
                    if (!event.id || event.id.length !== 64) {
                        log(`❌ ID نامعتبر: طول=${event.id?.length}`, 'error');
                        setStatus('❌ ID Event نامعتبر', 'error');
                        return;
                    }
                    
                    if (!event.sig || event.sig.length !== 128) {
                        log(`❌ امضا نامعتبر: طول=${event.sig?.length}`, 'error');
                        setStatus('❌ امضا Event نامعتبر', 'error');
                        return;
                    }
                    
                    log('✅ تمام بررسی‌ها موفق - Event معتبر است');
                    setStatus('✅ همه چیز درست است! مشکل ممکن است از سمت relay باشد.', 'success');
                    
                } catch (e) {
                    log(`❌ خطا در ایجاد Event: ${e.message}`, 'error');
                    setStatus('❌ مشکل در ایجاد Event', 'error');
                    return;
                }
                
            } catch (e) {
                log(`❌ خطای غیرمنتظره: ${e.message}`, 'error');
                setStatus('❌ خطای غیرمنتظره در تشخیص', 'error');
            }
        };
        
        // Clear and regenerate keys
        window.clearAndRegenerate = async function() {
            if (!confirm('آیا مطمئن هستید که می‌خواهید تمام کلیدها و داده‌ها را پاک کنید؟')) {
                return;
            }
            
            output.innerHTML = '';
            log('🗑️ پاک کردن localStorage...');
            
            // Clear all GlobGram data
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.includes('nostr') || key.includes('globgram') || key.includes('chat') || key.includes('relay')) {
                    localStorage.removeItem(key);
                    log(`پاک شد: ${key}`);
                }
            });
            
            try {
                // Generate new key
                const nostrTools = await import('nostr-tools');
                const secret = nostrTools.generateSecretKey();
                const hexSecretKey = bytesToHex(secret);
                const publicKey = nostrTools.getPublicKey(secret);
                
                localStorage.setItem('nostr_sk', hexSecretKey);
                
                log(`✅ کلید جدید ایجاد شد:`);
                log(`  کلید عمومی: ${publicKey.slice(0, 16)}...`);
                log(`  کلید خصوصی: ${hexSecretKey.slice(0, 16)}...`);
                
                setStatus('✅ کلید جدید با موفقیت ایجاد شد! صفحه اصلی را refresh کنید.', 'success');
                
            } catch (e) {
                log(`❌ خطا در ایجاد کلید جدید: ${e.message}`, 'error');
                setStatus('❌ مشکل در ایجاد کلید جدید', 'error');
            }
        };
        
        // Test event creation specifically
        window.testEventCreation = async function() {
            output.innerHTML = '';
            log('📝 تست ایجاد Event...');
            
            const sk = localStorage.getItem('nostr_sk');
            if (!sk) {
                setStatus('❌ ابتدا کلید ایجاد کنید', 'error');
                return;
            }
            
            try {
                const nostrTools = await import('nostr-tools');
                const skBytes = hexToBytes(sk);
                
                // Test different event types
                const eventTypes = [
                    { kind: 1, content: 'تست پیام عادی', desc: 'پیام عادی' },
                    { kind: 4, content: 'تست پیام مستقیم', desc: 'پیام مستقیم', tags: [['p', 'test']] },
                    { kind: 42, content: 'تست پیام گروهی', desc: 'پیام گروهی', tags: [['e', 'test']] }
                ];
                
                for (const eventType of eventTypes) {
                    try {
                        const template = {
                            kind: eventType.kind,
                            created_at: Math.floor(Date.now() / 1000),
                            content: eventType.content,
                            tags: eventType.tags || []
                        };
                        
                        const event = nostrTools.finalizeEvent(template, skBytes);
                        log(`✅ ${eventType.desc}: ID=${event.id.slice(0, 12)}...`);
                        
                    } catch (e) {
                        log(`❌ خطا در ${eventType.desc}: ${e.message}`, 'error');
                    }
                }
                
                setStatus('✅ تست ایجاد Event‌ها کامل شد', 'success');
                
            } catch (e) {
                log(`❌ خطا در تست: ${e.message}`, 'error');
                setStatus('❌ مشکل در تست ایجاد Event', 'error');
            }
        };
        
        // Test relay connection
        window.testRelayConnection = async function() {
            output.innerHTML = '';
            log('🌐 تست اتصال به Relay...');
            
            const relayUrl = 'wss://relay1.matrus.org';
            
            try {
                const ws = new WebSocket(relayUrl);
                
                ws.onopen = () => {
                    log(`✅ اتصال برقرار شد: ${relayUrl}`);
                    setStatus('✅ اتصال به relay موفق', 'success');
                    
                    // Send a simple REQ to test
                    const req = JSON.stringify(['REQ', 'test', { kinds: [1], limit: 1 }]);
                    ws.send(req);
                    log('📤 درخواست تست ارسال شد');
                };
                
                ws.onmessage = (msg) => {
                    try {
                        const data = JSON.parse(msg.data);
                        log(`📥 پاسخ relay: ${data[0]} ${data[1] || ''}`);
                        
                        if (data[0] === 'NOTICE') {
                            log(`📢 اعلان relay: ${data[1]}`);
                        }
                    } catch (e) {
                        log(`📥 پیام خام: ${msg.data}`);
                    }
                };
                
                ws.onerror = (error) => {
                    log(`❌ خطا در اتصال relay: ${error}`, 'error');
                    setStatus('❌ مشکل در اتصال به relay', 'error');
                };
                
                ws.onclose = (event) => {
                    log(`🔌 اتصال relay بسته شد: کد=${event.code}`);
                    if (event.code !== 1000) {
                        setStatus('⚠️ اتصال relay غیرعادی بسته شد', 'warning');
                    }
                };
                
                // Close after 5 seconds
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                        log('🕐 اتصال بعد از 5 ثانیه بسته شد');
                    }
                }, 5000);
                
            } catch (e) {
                log(`❌ خطا در ایجاد اتصال: ${e.message}`, 'error');
                setStatus('❌ مشکل در ایجاد اتصال WebSocket', 'error');
            }
        };
        
        // Auto-run diagnostics on load
        setTimeout(() => {
            runDiagnostics();
        }, 1000);
    </script>
</body>
</html>
